<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω S·∫£n ph·∫©m - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/products.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
      <p>Qu·∫£n tr·ªã h·ªá th·ªëng</p>
    </div>
    
    <div class="sidebar-menu">
      <ul>
        <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li><a href="user.html"><i class="fas fa-users"></i> <span>Qu·∫£n l√Ω kh√°ch h√†ng</span></a></li>
        <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> <span>ƒê∆°n h√†ng</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-box"></i> <span>S·∫£n ph·∫©m</span></a></li>
        <li><a href="admin.html"><i class="fas fa-user-shield"></i> <span>Qu·∫£n l√Ω admin</span></a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i> <span>C√†i ƒë·∫∑t</span></a></li>
        <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/150?img=12" alt="Admin Avatar">
        <div>
          <h3 id="adminName">Nguy·ªÖn ƒê·ª©c Huy</h3>
          <p>Qu·∫£n tr·ªã vi√™n</p>
        </div>
      </div>
    </div>
    
    <div class="search-filter">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m...">
      </div>
      <select class="filter-select" id="categoryFilter">
        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
      </select>
      <select class="filter-select" id="brandFilter">
        <option value="">T·∫•t c·∫£ th∆∞∆°ng hi·ªáu</option>
      </select>
      <select class="filter-select" id="statusFilter">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="active">ƒêang b√°n</option>
        <option value="inactive">Ng·ª´ng b√°n</option>
      </select>
      <button class="btn btn-primary" id="addProductBtn">
        <i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m
      </button>
    </div>
    
    <!-- Products Table -->
    <div class="table-container">
      <div class="table-header">
        <h2>Danh s√°ch s·∫£n ph·∫©m</h2>
        <div>
          <button class="btn btn-outline" id="exportBtn">
            <i class="fas fa-download"></i> Xu·∫•t Excel
          </button>
        </div>
      </div>
      
      <table>
        <thead>
            <tr>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>M√¥ t·∫£</th>
            <th>Danh m·ª•c</th>
            <th>Th∆∞∆°ng hi·ªáu</th>
            <th>Gi√° nh·∫≠p</th>
            <th>Gi√° b√°n</th>
            <th>T·ªìn kho</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="productsTableBody">
            <!-- Products will be populated by JavaScript -->
        </tbody>
    </table>
      
      <!-- Pagination -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <div id="paginationInfo">Hi·ªÉn th·ªã 0 s·∫£n ph·∫©m</div>
        <div>
          <button class="btn btn-outline" id="prevPageBtn" disabled>
            <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
          </button>
          <span id="pageInfo" style="margin: 0 10px;">Trang 1 / 1</span>
          <button class="btn btn-outline" id="nextPageBtn" disabled>
            Sau <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Product Modal -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Th√™m s·∫£n ph·∫©m m·ªõi</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          
          <div class="form-group">
            <label for="productName">T√™n s·∫£n ph·∫©m *</label>
            <input type="text" id="productName" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="productDescription">M√¥ t·∫£</label>
            <textarea id="productDescription" class="form-control" rows="3"></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="categoryId">Danh m·ª•c *</label>
              <select id="categoryId" class="form-control" required>
                <option value="">Ch·ªçn danh m·ª•c</option>
                <!-- Categories will be populated by JavaScript -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="brandId">Th∆∞∆°ng hi·ªáu *</label>
              <select id="brandId" class="form-control" required>
                <option value="">Ch·ªçn th∆∞∆°ng hi·ªáu</option>
                <!-- Brands will be populated by JavaScript -->
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="leagueId">Gi·∫£i ƒë·∫•u *</label>
              <select id="leagueId" class="form-control" required>
                <option value="">Ch·ªçn gi·∫£i ƒë·∫•u</option>
                <!-- Leagues will be populated by JavaScript -->
              </select>
          </div>
            
            <div class="form-group">
              <label for="sizeId">K√≠ch th∆∞·ªõc</label>
              <select id="sizeId" class="form-control">
                <option value="">Ch·ªçn k√≠ch th∆∞·ªõc</option>
                <!-- Sizes will be populated by JavaScript -->
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="importPrice">Gi√° nh·∫≠p *</label>
              <input type="number" id="importPrice" class="form-control" min="0" step="0.01" required>
            </div>
            
            <div class="form-group">
              <label for="sellingPrice">Gi√° b√°n *</label>
              <input type="number" id="sellingPrice" class="form-control" min="0" step="0.01" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="discount">Gi·∫£m gi√° (%)</label>
              <input type="number" id="discount" class="form-control" min="0" max="100" step="0.01" value="0">
            </div>
            
            <div class="form-group">
              <label for="stockQuantity">S·ªë l∆∞·ª£ng t·ªìn kho *</label>
              <input type="number" id="stockQuantity" class="form-control" min="0" required value="0">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="unit">ƒê∆°n v·ªã</label>
              <input type="text" id="unit" class="form-control" value="C√°i">
            </div>
            
            <div class="form-group">
              <label for="season">M√πa</label>
              <input type="text" id="season" class="form-control" placeholder="V√≠ d·ª•: 2023-2024">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="playerName">T√™n c·∫ßu th·ªß</label>
              <input type="text" id="playerName" class="form-control">
            </div>
          </div>
          
          <div class="form-group">
            <label for="imageURL">URL h√¨nh ·∫£nh</label>
            <input type="text" id="imageURL" class="form-control" placeholder="https://example.com/image.jpg">
          </div>
          
          <div class="form-group">
            <label for="status">Tr·∫°ng th√°i</label>
            <select id="status" class="form-control">
              <option value="active">ƒêang b√°n</option>
              <option value="inactive">Ng·ª´ng b√°n</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelBtn">H·ªßy</button>
        <button class="btn btn-primary" id="saveProductBtn">L∆∞u s·∫£n ph·∫©m</button>
      </div>
    </div>
  </div>

  <script>
    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) {
          return decodeURIComponent(cookieValue);
        }
      }
      return null;
    }
    
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
    }

    let products = [];
    let categories = [];
    let brands = [];
    let clubs = [];
    let sizes = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let editingProductId = null;

    function checkAuth() {
      const userDataCookie = getCookie("user_data");
      
      if (!userDataCookie) {
        window.location.href = "/login.html";
        return false;
      }
      
      try {
        const user = JSON.parse(userDataCookie);
        
        if (user.username) {
          document.getElementById('adminName').textContent = user.username;
        }
        
        if (!user.isSuperAdmin) {
          const adminMenuItem = document.querySelector('.sidebar-menu a[href="admin.html"]').parentElement;
          if (adminMenuItem) {
            adminMenuItem.style.display = 'none';
          }
        }
        
        return true;
      } catch (error) {
        console.error('L·ªói parse cookie:', error);
        window.location.href = "/login.html";
        return false;
      }
    }

    async function logout() {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          deleteCookie("user_data");
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error('Logout error:', error);
        deleteCookie("user_data");
        window.location.href = "login.html";
      }
    }

    async function loadCategories() {
      try {
        const response = await fetch('/product/categories');
        if (!response.ok) throw new Error('L·ªói API');
        categories = await response.json();
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i danh m·ª•c:', error);
        categories = [
          { CategoryID: 1, CategoryName: "√Åo b√≥ng ƒë√°" },
          { CategoryID: 2, CategoryName: "Qu·∫ßn b√≥ng ƒë√°" },
          { CategoryID: 3, CategoryName: "Gi√†y b√≥ng ƒë√°" },
          { CategoryID: 4, CategoryName: "Ph·ª• ki·ªán" },
          { CategoryID: 5, CategoryName: "√Åo kho√°c th·ªÉ thao" }
        ];
      }
      populateCategoryDropdowns();
    }

    async function loadBrands() {
      try {
        const response = await fetch('/product/brands');
        if (!response.ok) throw new Error('L·ªói API');
        brands = await response.json();
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i th∆∞∆°ng hi·ªáu:', error);
        brands = [
          { BrandID: 1, BrandName: "Adidas" },
          { BrandID: 2, BrandName: "Nike" },
          { BrandID: 3, BrandName: "Puma" },
          { BrandID: 4, BrandName: "Mizuno" }
        ];
      }
      populateBrandDropdowns();
    }

    async function loadLeagues() {
  try {
    const response = await fetch('/product/leagues');
    if (!response.ok) throw new Error('L·ªói API');
    leagues = await response.json();
  } catch (error) {
    console.error('‚ùå L·ªói khi t·∫£i gi·∫£i ƒë·∫•u:', error);
    leagues = [
      { LeagueID: 1, LeagueName: "Premier League" },
      { LeagueID: 2, LeagueName: "La Liga" },
      { LeagueID: 3, LeagueName: "Serie A" },
      { LeagueID: 4, LeagueName: "Bundesliga" },
      { LeagueID: 5, LeagueName: "Ligue 1" },
      { LeagueID: 6, LeagueName: "Champions League" }
    ];
  }
  populateLeagueDropdown();
}

// TH√äM h√†m populateLeagueDropdown
function populateLeagueDropdown() {
  const leagueId = document.getElementById('leagueId');
  
  // X√≥a c√°c option hi·ªán t·∫°i (tr·ª´ option ƒë·∫ßu ti√™n)
  while (leagueId.children.length > 1) {
    leagueId.removeChild(leagueId.lastChild);
  }
  
  // Th√™m c√°c option m·ªõi
  leagues.forEach(league => {
    const option = document.createElement('option');
    option.value = league.LeagueID;
    option.textContent = league.LeagueName;
    leagueId.appendChild(option);
  });
}

    async function loadSizes() {
      try {
        const response = await fetch('/product/sizes');
        if (!response.ok) throw new Error('L·ªói API');
        sizes = await response.json();
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i k√≠ch th∆∞·ªõc:', error);
        sizes = [
          { SizeID: 1, SizeName: "S" },
          { SizeID: 2, SizeName: "M" },
          { SizeID: 3, SizeName: "L" },
          { SizeID: 4, SizeName: "XL" },
          { SizeID: 5, SizeName: "XXL" },
          { SizeID: 6, SizeName: "39" },
          { SizeID: 7, SizeName: "40" },
          { SizeID: 8, SizeName: "41" },
          { SizeID: 9, SizeName: "42" },
          { SizeID: 10, SizeName: "43" }
        ];
      }
      populateSizeDropdown();
    }

// H√†m t·∫£i s·∫£n ph·∫©m - S·ª¨A L·∫†I
async function loadProducts() {
  try {
    console.log("üîÑ ƒêang t·∫£i danh s√°ch s·∫£n ph·∫©m...");
    
    const response = await fetch('/product');
    
    // Ki·ªÉm tra response status
    if (response.status === 404) {
      console.warn('‚ö†Ô∏è API /product kh√¥ng t·ªìn t·∫°i (404)');
      showFallbackProducts();
      return;
    }
    
    if (!response.ok) {
      console.warn(`‚ö†Ô∏è API tr·∫£ v·ªÅ l·ªói ${response.status}: ${response.statusText}`);
      showFallbackProducts();
      return;
    }
    
    const data = await response.json();
    console.log(`‚úÖ Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu:`, data);
    
    // Ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu
    if (!data) {
      console.warn('‚ö†Ô∏è API tr·∫£ v·ªÅ null/undefined');
      showFallbackProducts();
      return;
    }
    
    // N·∫øu data l√† object (c√≥ th·ªÉ l√† th√¥ng b√°o l·ªói)
    if (typeof data === 'object' && !Array.isArray(data)) {
      console.warn('‚ö†Ô∏è API tr·∫£ v·ªÅ object thay v√¨ m·∫£ng:', data);
      // V·∫´n c√≥ th·ªÉ l√† m·∫£ng r·ªóng {}
      if (data.message) {
        console.log(`Th√¥ng b√°o t·ª´ server: ${data.message}`);
      }
      showFallbackProducts();
      return;
    }
    
    // N·∫øu l√† m·∫£ng
    products = Array.isArray(data) ? data : [];
    console.log(`‚úÖ C√≥ ${products.length} s·∫£n ph·∫©m`);
    
    renderProducts();
    
  } catch (error) {
    console.error('‚ùå L·ªói khi t·∫£i s·∫£n ph·∫©m:', error);
    
    // Hi·ªÉn th·ªã th√¥ng b√°o c·ª• th·ªÉ
    if (error.name === 'AbortError') {
      console.warn('‚è∞ Request b·ªã h·ªßy do timeout');
    } else if (error.name === 'TypeError') {
      console.warn('üîó L·ªói k·∫øt n·ªëi network ho·∫∑c CORS');
    }
    
    // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u
    showFallbackProducts();
  }
}

    // V√Ä ƒê·∫¢M B·∫¢O C√ì H√ÄM showFallbackProducts
    function showFallbackProducts() {
      products = [
        {
          ProductID: 1,
          ProductName: "√Åo ƒë·∫•u Inter Miami Messi Edition 2024",
          CategoryID: 1,
          CategoryName: "√Åo b√≥ng ƒë√°",
          BrandID: 2,
          BrandName: "Adidas",
          ImportPrice: 500000,
          SellingPrice: 800000,
          Discount: 10,
          StockQuantity: 75,
          Status: "active",
          ImageURL: "https://via.placeholder.com/150x150/FF6B6B/FFFFFF?text=Inter+Miami",
          Description: "√Åo ƒë·∫•u ch√≠nh th·ª©c Inter Miami v·ªõi thi·∫øt k·∫ø Messi Edition ƒë·ªôc quy·ªÅn"
        },
        {
          ProductID: 2,
          ProductName: "Gi√†y Nike Mercurial Superfly 9",
          CategoryID: 3,
          CategoryName: "Gi√†y b√≥ng ƒë√°",
          BrandID: 1,
          BrandName: "Nike",
          ImportPrice: 1200000,
          SellingPrice: 1800000,
          Discount: 15,
          StockQuantity: 25,
          Status: "active",
          ImageURL: "https://via.placeholder.com/150x150/4ECDC4/FFFFFF?text=Nike+Mercurial",
          Description: "Gi√†y b√≥ng ƒë√° cao c·∫•p v·ªõi c√¥ng ngh·ªá Flyknit"
        }
      ];
      
      renderProducts();
    }

    // ƒêi·ªÅn danh m·ª•c v√†o dropdown
    function populateCategoryDropdowns() {
      const categoryFilter = document.getElementById('categoryFilter');
      const categoryId = document.getElementById('categoryId');
      
      // X√≥a c√°c option hi·ªán t·∫°i (tr·ª´ option ƒë·∫ßu ti√™n)
      while (categoryFilter.children.length > 1) {
        categoryFilter.removeChild(categoryFilter.lastChild);
      }
      while (categoryId.children.length > 1) {
        categoryId.removeChild(categoryId.lastChild);
      }
      
      // Th√™m c√°c option m·ªõi
      categories.forEach(category => {
        const option1 = document.createElement('option');
        option1.value = category.CategoryID;
        option1.textContent = category.CategoryName;
        categoryFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = category.CategoryID;
        option2.textContent = category.CategoryName;
        categoryId.appendChild(option2);
      });
    }

    // ƒêi·ªÅn th∆∞∆°ng hi·ªáu v√†o dropdown
    function populateBrandDropdowns() {
      const brandFilter = document.getElementById('brandFilter');
      const brandId = document.getElementById('brandId');
      
      // X√≥a c√°c option hi·ªán t·∫°i (tr·ª´ option ƒë·∫ßu ti√™n)
      while (brandFilter.children.length > 1) {
        brandFilter.removeChild(brandFilter.lastChild);
      }
      while (brandId.children.length > 1) {
        brandId.removeChild(brandId.lastChild);
      }
      
      // Th√™m c√°c option m·ªõi
      brands.forEach(brand => {
        const option1 = document.createElement('option');
        option1.value = brand.BrandID;
        option1.textContent = brand.BrandName;
        brandFilter.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = brand.BrandID;
        option2.textContent = brand.BrandName;
        brandId.appendChild(option2);
      });
    }

    // ƒêi·ªÅn c√¢u l·∫°c b·ªô v√†o dropdown
    function populateClubDropdown() {
      const clubId = document.getElementById('clubId');
      
      // X√≥a c√°c option hi·ªán t·∫°i (tr·ª´ option ƒë·∫ßu ti√™n)
      while (clubId.children.length > 1) {
        clubId.removeChild(clubId.lastChild);
      }
      
      // Th√™m c√°c option m·ªõi
      clubs.forEach(club => {
        const option = document.createElement('option');
        option.value = club.ClubID;
        option.textContent = club.ClubName;
        clubId.appendChild(option);
      });
    }

    // ƒêi·ªÅn k√≠ch th∆∞·ªõc v√†o dropdown
    function populateSizeDropdown() {
      const sizeId = document.getElementById('sizeId');
      
      // X√≥a c√°c option hi·ªán t·∫°i (tr·ª´ option ƒë·∫ßu ti√™n)
      while (sizeId.children.length > 1) {
        sizeId.removeChild(sizeId.lastChild);
      }
      
      // Th√™m c√°c option m·ªõi
      sizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size.SizeID;
        option.textContent = size.SizeName;
        sizeId.appendChild(option);
      });
    }

    // Hi·ªÉn th·ªã s·∫£n ph·∫©m l√™n b·∫£ng
    function renderProducts() {
      const tbody = document.getElementById('productsTableBody');
      if (!tbody) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng s·∫£n ph·∫©m');
        return;
      }
      // L·ªçc s·∫£n ph·∫©m theo t√¨m ki·∫øm v√† b·ªô l·ªçc
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const brandFilter = document.getElementById('brandFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      // S·ª¨A L·∫†I PH·∫¶N N√ÄY - ƒë·∫∑t m·∫∑c ƒë·ªãnh: null = active (ƒëang b√°n)
      let filteredProducts = products.filter(product => {
        const matchesSearch = product.ProductName.toLowerCase().includes(searchTerm) || 
                             (product.Description && product.Description.toLowerCase().includes(searchTerm));
        const matchesCategory = !categoryFilter || product.CategoryID == categoryFilter;
        const matchesBrand = !brandFilter || product.BrandID == brandFilter;
        
        // ƒê·∫∑t m·∫∑c ƒë·ªãnh: null = active (ƒëang b√°n)
        const productStatus = product.Status === null || product.Status === 'null' ? 'active' : product.Status;
        
        const matchesStatus = !statusFilter || productStatus === statusFilter;
        
        return matchesSearch && matchesCategory && matchesBrand && matchesStatus;
      });

      // T√≠nh to√°n ph√¢n trang
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredProducts.length);
      const paginatedProducts = filteredProducts.slice(startIndex, endIndex);
      
      // C·∫≠p nh·∫≠t th√¥ng tin ph√¢n trang
      document.getElementById('paginationInfo').textContent = 
      `Hi·ªÉn th·ªã ${startIndex + 1}-${endIndex} c·ªßa ${filteredProducts.length} s·∫£n ph·∫©m`;
      document.getElementById('pageInfo').textContent = `Trang ${currentPage} / ${totalPages}`;
      
      // C·∫≠p nh·∫≠t n√∫t ph√¢n trang
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
      
      // X√≥a d·ªØ li·ªáu c≈©
      tbody.innerHTML = '';
      
      if (paginatedProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</td></tr>';
        return;
      }
      
      // Th√™m s·∫£n ph·∫©m v√†o b·∫£ng
      paginatedProducts.forEach(product => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>
            <img src="${product.ImageURL || 'https://via.placeholder.com/45x45?text=IMG'}" 
                 alt="${product.ProductName}" class="product-image">
          </td>
          <td class="product-name">${product.ProductName}</td>
          <td class="category-name">${product.CategoryName || 'N/A'}</td>
          <td>${product.BrandName || 'N/A'}</td>
          <td><span class="currency">${formatCurrencyCompact(product.ImportPrice)}</span></td>
          <td>
            ${product.Discount > 0 ? 
              `<div>
                <div style="text-decoration: line-through; color: #999; font-size: 0.7rem;">
                  ${formatCurrencyCompact(product.SellingPrice)}
                </div>
                <div class="currency" style="color: #e74c3c; font-weight: bold;">
                  ${formatCurrencyCompact(product.SellingPrice * (1 - product.Discount/100))}
                </div>
                <div style="color: #e74c3c; font-size: 0.7rem;">-${product.Discount}%</div>
              </div>` : 
              `<span class="currency">${formatCurrencyCompact(product.SellingPrice)}</span>`
            }
          </td>
          <td>${product.StockQuantity}</td>
          <td>
            <span class="status ${getStatusClass(product.Status)}">
              ${getStatusText(product.Status)}
            </span>
          </td>
          <td>
            <button class="btn btn-outline" onclick="editProduct(${product.ProductID})" title="S·ª≠a">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger" onclick="deleteProduct(${product.ProductID})" title="X√≥a">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function getStatusText(status) {
      // Coi null nh∆∞ 'active' (ƒëang b√°n)
      if (status === null || status === 'null' || status === 'undefined') {
        return 'ƒêang b√°n';
      }
      
      const statusMap = {
        'active': 'ƒêang b√°n',
        'inactive': 'Ng·ª´ng b√°n'
      };
      return statusMap[status] || 'ƒêang b√°n'; // M·∫∑c ƒë·ªãnh l√† ƒêang b√°n
    }

    // S·ª≠a h√†m getStatusClass - coi null nh∆∞ 'active'
    function getStatusClass(status) {
      // Coi null nh∆∞ 'active'
      if (status === null || status === 'null' || status === 'undefined') {
        return 'active';
      }
      
      const statusMap = {
        'active': 'active',
        'inactive': 'inactive'
      };
      return statusMap[status] || 'active'; // M·∫∑c ƒë·ªãnh l√† active
    }

    // Th√™m h√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá g·ªçn h∆°n
    function formatCurrencyCompact(amount) {
      if (!amount) return '0‚Ç´';
      if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'tr';
      }
      if (amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'k';
      }
      return new Intl.NumberFormat('vi-VN').format(amount) + '‚Ç´';
    }

    // H√†m c·∫Øt text ng·∫Øn h∆°n
    function truncateText(text, maxLength) {
      if (!text) return 'N/A';
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    function showFallbackProducts() {
      products = [
        {
          ProductID: 1,
          ProductName: "√Åo ƒë·∫•u s√¢n nh√† Manchester United 2023",
          CategoryName: "√Åo b√≥ng ƒë√°",
          BrandName: "Adidas",
          ImportPrice: 450000,
          SellingPrice: 850000,
          StockQuantity: 50,
          Status: "active",
          ImageURL: "https://via.placeholder.com/60x60?text=MU"
        },
        {
          ProductID: 2,
          ProductName: "√Åo ƒë·∫•u s√¢n kh√°ch Real Madrid 2023",
          CategoryName: "√Åo b√≥ng ƒë√°",
          BrandName: "Adidas",
          ImportPrice: 480000,
          SellingPrice: 900000,
          StockQuantity: 35,
          Status: "active",
          ImageURL: "https://via.placeholder.com/60x60?text=RM"
        },
        {
          ProductID: 3,
          ProductName: "Gi√†y b√≥ng ƒë√° Nike Mercurial Vapor",
          CategoryName: "Gi√†y b√≥ng ƒë√°",
          BrandName: "Nike",
          ImportPrice: 650000,
          SellingPrice: 1200000,
          StockQuantity: 20,
          Status: "active",
          ImageURL: "https://via.placeholder.com/60x60?text=Nike"
        }
      ];
      
      renderProducts();
    }

    // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
    function formatCurrency(amount) {
      if (!amount) return '0 VNƒê';
      return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
    }

    // M·ªü modal th√™m s·∫£n ph·∫©m
    function openAddModal() {
      editingProductId = null;
      document.getElementById('modalTitle').textContent = 'Th√™m s·∫£n ph·∫©m m·ªõi';
      document.getElementById('productForm').reset();
      document.getElementById('productId').value = '';
      document.getElementById('status').value = 'active';
      document.getElementById('productModal').style.display = 'flex';
    }

    function editProduct(productId) {
      const product = products.find(p => p.ProductID === productId);
      if (!product) {
        alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
        return;
      }
      
      editingProductId = productId;
      document.getElementById('modalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
      document.getElementById('productId').value = product.ProductID;
      document.getElementById('productName').value = product.ProductName;
      document.getElementById('productDescription').value = product.Description || '';
      document.getElementById('categoryId').value = product.CategoryID || '';
      document.getElementById('brandId').value = product.BrandID || '';
      document.getElementById('leagueId').value = product.LeagueID || '1'; // CH·ªàNH L·∫†I
      document.getElementById('sizeId').value = product.SizeID || '';
      document.getElementById('importPrice').value = product.ImportPrice || '';
      document.getElementById('sellingPrice').value = product.SellingPrice || '';
      document.getElementById('discount').value = product.Discount || 0;
      document.getElementById('stockQuantity').value = product.StockQuantity || 0;
      document.getElementById('unit').value = product.Unit || 'C√°i';
      document.getElementById('season').value = product.Season || '';
      document.getElementById('playerName').value = product.PlayerName || '';
      document.getElementById('imageURL').value = product.ImageURL || '';
      document.getElementById('status').value = product.Status || 'active';
      document.getElementById('productModal').style.display = 'flex';
    }

    // ƒê√≥ng modal
    function closeModal() {
      document.getElementById('productModal').style.display = 'none';
    }

    // S·ª¨A H√ÄM saveProduct
    async function saveProduct() {
      const form = document.getElementById('productForm');
      if (!form.checkValidity()) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
      }
      
      // T√≠nh to√°n gi√° b√°n sau gi·∫£m gi√°
      const sellingPrice = parseFloat(document.getElementById('sellingPrice').value);
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const finalPrice = sellingPrice * (1 - discount / 100);
      
      const productData = {
        ProductName: document.getElementById('productName').value,
        Description: document.getElementById('productDescription').value,
        CategoryID: parseInt(document.getElementById('categoryId').value),
        BrandID: parseInt(document.getElementById('brandId').value),
        ImageURL: document.getElementById('imageURL').value,
        ImportPrice: parseFloat(document.getElementById('importPrice').value),
        SellingPrice: sellingPrice,
        Discount: discount,
        FinalPrice: finalPrice,
        StockQuantity: parseInt(document.getElementById('stockQuantity').value),
        Unit: document.getElementById('unit').value,
        LeagueID: document.getElementById('leagueId').value ? parseInt(document.getElementById('leagueId').value) : 1,
        SizeID: document.getElementById('sizeId').value ? parseInt(document.getElementById('sizeId').value) : null,
        Season: document.getElementById('season').value,
        PlayerName: document.getElementById('playerName').value,
        Status: document.getElementById('status').value
      };
      
      try {
        let response;
        if (editingProductId) {
          response = await fetch(`/product/${editingProductId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
          });
        } else {
          response = await fetch('/product', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
          });
        }
        
        if (!response.ok) throw new Error('L·ªói khi l∆∞u s·∫£n ph·∫©m');
        
        const result = await response.json();
        alert(result.message || 'L∆∞u s·∫£n ph·∫©m th√†nh c√¥ng');
        
        closeModal();
        loadProducts();
        
      } catch (error) {
        console.error('‚ùå L·ªói khi l∆∞u s·∫£n ph·∫©m:', error);
        alert('L·ªói khi l∆∞u s·∫£n ph·∫©m: ' + error.message);
      }
    }

    // X√≥a s·∫£n ph·∫©m
    async function deleteProduct(productId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
        return;
      }
      
      try {
        const response = await fetch(`/product/${productId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('L·ªói khi x√≥a s·∫£n ph·∫©m');
        
        const result = await response.json();
        alert(result.message || 'X√≥a s·∫£n ph·∫©m th√†nh c√¥ng');
        
        loadProducts(); // T·∫£i l·∫°i danh s√°ch s·∫£n ph·∫©m
        
      } catch (error) {
        console.error('‚ùå L·ªói khi x√≥a s·∫£n ph·∫©m:', error);
        alert('L·ªói khi x√≥a s·∫£n ph·∫©m: ' + error.message);
      }
    }

    // Xu·∫•t Excel (ch·ª©c nƒÉng gi·∫£ l·∫≠p)
    function exportToExcel() {
      alert('T√≠nh nƒÉng xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai sau');
      // Tri·ªÉn khai th·ª±c t·∫ø s·∫Ω s·ª≠ d·ª•ng th∆∞ vi·ªán nh∆∞ SheetJS
    }

    // S·ª± ki·ªán khi trang ƒë∆∞·ª£c t·∫£i
    document.addEventListener('DOMContentLoaded', function() {
      console.log("üöÄ Trang s·∫£n ph·∫©m ƒëang t·∫£i...");
      
      // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
      if (!checkAuth()) return;
      
      // T·∫£i d·ªØ li·ªáu
      loadProducts();
      loadCategories();
      loadBrands();
      loadLeagues();
      loadSizes();
      
      // X·ª≠ l√Ω menu active
      const menuItems = document.querySelectorAll('.sidebar-menu li');
      menuItems.forEach(item => {
        item.addEventListener('click', function() {
          menuItems.forEach(i => i.classList.remove('active'));
          this.classList.add('active');
        });
      });
      
      // G√°n s·ª± ki·ªán
      document.getElementById('addProductBtn').addEventListener('click', openAddModal);
      document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
      document.getElementById('cancelBtn').addEventListener('click', closeModal);
      document.querySelector('.close-modal').addEventListener('click', closeModal);
      document.getElementById('exportBtn').addEventListener('click', exportToExcel);
      
      // S·ª± ki·ªán t√¨m ki·∫øm v√† l·ªçc
      document.getElementById('searchInput').addEventListener('input', renderProducts);
      document.getElementById('categoryFilter').addEventListener('change', renderProducts);
      document.getElementById('brandFilter').addEventListener('change', renderProducts);
      document.getElementById('statusFilter').addEventListener('change', renderProducts);
      
      // S·ª± ki·ªán ph√¢n trang
      document.getElementById('prevPageBtn').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderProducts();
        }
      });
      
      document.getElementById('nextPageBtn').addEventListener('click', () => {
        const totalPages = Math.ceil(products.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderProducts();
        }
      });
    });
  </script>
</body>
</html>