<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/admin/css/style.css">
  <link rel="stylesheet" href="/admin/css/orders.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
      <p>Qu·∫£n tr·ªã h·ªá th·ªëng</p>
    </div>
    
    <div class="sidebar-menu">
      <ul>
        <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li><a href="user.html"><i class="fas fa-users"></i> <span>Qu·∫£n l√Ω kh√°ch h√†ng</span></a></li>
        <li class="active"><a href="orders.html"><i class="fas fa-shopping-cart"></i> <span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="products.html"><i class="fas fa-box"></i> <span>S·∫£n ph·∫©m</span></a></li>
        <li><a href="admin.html"><i class="fas fa-user-shield"></i> <span>Qu·∫£n l√Ω admin</span></a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i> <span>C√†i ƒë·∫∑t</span></a></li>
        <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/150?img=12" alt="Admin Avatar">
        <div>
          <h3 id="adminName">Nguy·ªÖn ƒê·ª©c Huy</h3>
          <p>Qu·∫£n tr·ªã vi√™n</p>
        </div>
      </div>
    </div>
    
    <!-- Order Stats -->
    <div class="stats-cards">
      <div class="card">
        <div class="stat-card">
          <div class="stat-info">
            <h3>T·ªïng ƒë∆°n h√†ng</h3>
            <h2 id="totalOrders">0</h2>
          </div>
          <div class="stat-icon bg-primary">
            <i class="fas fa-shopping-cart"></i>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="stat-card">
          <div class="stat-info">
            <h3>ƒêang x·ª≠ l√Ω</h3>
            <h2 id="pendingOrders">0</h2>
          </div>
          <div class="stat-icon bg-warning">
            <i class="fas fa-clock"></i>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="stat-card">
          <div class="stat-info">
            <h3>ƒêang giao h√†ng</h3>
            <h2 id="shippingOrders">0</h2>
          </div>
          <div class="stat-icon bg-success">
            <i class="fas fa-shipping-fast"></i>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="stat-card">
          <div class="stat-info">
            <h3>ƒê√£ ho√†n th√†nh</h3>
            <h2 id="completedOrders">0</h2>
          </div>
          <div class="stat-icon bg-dark">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label for="statusFilter">Tr·∫°ng th√°i</label>
          <select id="statusFilter">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="pending">ƒêang ch·ªù x·ª≠ l√Ω</option>
            <option value="shipping">ƒêang giao h√†ng</option>
            <option value="completed">ƒê√£ ho√†n th√†nh</option>
            <option value="cancelled">ƒê√£ h·ªßy</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="dateFrom">T·ª´ ng√†y</label>
          <input type="date" id="dateFrom">
        </div>
        
        <div class="filter-group">
          <label for="dateTo">ƒê·∫øn ng√†y</label>
          <input type="date" id="dateTo">
        </div>
        
        <div class="filter-group">
          <label for="searchOrder">T√¨m ki·∫øm</label>
          <input type="text" id="searchOrder" placeholder="M√£ ƒë∆°n h√†ng, t√™n kh√°ch h√†ng...">
        </div>
      </div>
      
      <div class="filter-actions">
        <button class="btn btn-outline" onclick="resetFilters()">
          <i class="fas fa-redo"></i> ƒê·∫∑t l·∫°i
        </button>
        <button class="btn btn-primary" onclick="applyFilters()">
          <i class="fas fa-filter"></i> L·ªçc ƒë∆°n h√†ng
        </button>
      </div>
    </div>
    
    <!-- Orders Table -->
    <div class="table-container">
      <div class="table-header">
        <h2>Danh s√°ch ƒë∆°n h√†ng</h2>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>M√£ ƒë∆°n h√†ng</th>
            <th>Kh√°ch h√†ng</th>
            <th>Ng√†y ƒë·∫∑t</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ph∆∞∆°ng th·ª©c TT</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="ordersTableBody">
          <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination">
        <!-- Pagination s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
    </div>
  </div>

<script>
    // H√†m helper ƒë·ªÉ l√†m vi·ªác v·ªõi cookies
    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) {
          return decodeURIComponent(cookieValue);
        }
      }
      return null;
    }
    
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
    }

    // Bi·∫øn to√†n c·ª•c
    let allOrders = [];
    let currentPage = 1;
    const ordersPerPage = 10;
    let currentFilters = {};

    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    document.addEventListener('DOMContentLoaded', function() {
        const userDataCookie = getCookie("user_data");
        
        if (!userDataCookie) {
            // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p th√¨ chuy·ªÉn v·ªÅ trang login
            window.location.href = "/login.html";
            return;
        }
        
        try {
            const user = JSON.parse(userDataCookie);
            
            // Hi·ªÉn th·ªã t√™n admin
            if (user.username) {
                const adminNameElement = document.getElementById('adminName');
                if (adminNameElement) {
                    adminNameElement.textContent = user.username;
                }
            }
            
            // Ki·ªÉm tra n·∫øu kh√¥ng ph·∫£i super admin th√¨ ·∫©n menu qu·∫£n l√Ω admin
            if (!user.isSuperAdmin) {
                const adminMenuItem = document.querySelector('.sidebar-menu a[href="admin.html"]');
                if (adminMenuItem && adminMenuItem.parentElement) {
                    adminMenuItem.parentElement.style.display = 'none';
                }
            }
            
            // T·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng
            loadOrders();
            loadOrderStats();
        } catch (error) {
            console.error('L·ªói parse cookie:', error);
            window.location.href = "/login.html";
        }
    });

    // H√†m ƒëƒÉng xu·∫•t
    async function logout() {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.ok) {
                // X√≥a cookies client side
                deleteCookie("user_data");
                window.location.href = "login.html";
            } else {
                // V·∫´n redirect v·ªÅ login
                deleteCookie("user_data");
                window.location.href = "login.html";
            }
        } catch (error) {
            console.error('Logout error:', error);
            // V·∫´n redirect v·ªÅ login
            deleteCookie("user_data");
            window.location.href = "login.html";
        }
    }

    // H√†m t·∫£i danh s√°ch ƒë∆°n h√†ng
    async function loadOrders() {
        try {
            console.log("üîÑ ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...");
            
            const response = await fetch('/api/order');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            allOrders = await response.json();
            console.log("üì¶ Danh s√°ch ƒë∆°n h√†ng:", allOrders);
            
            updateOrderStats();
            displayOrders();
            
        } catch (error) {
            console.error('‚ùå L·ªói khi t·∫£i ƒë∆°n h√†ng:', error);
            showFallbackData();
        }
    }

    // H√†m l·∫•y th·ªëng k√™ ƒë∆°n h√†ng
    async function loadOrderStats() {
        try {
            const response = await fetch('/api/order/stats');
            if (!response.ok) throw new Error('L·ªói khi t·∫£i th·ªëng k√™');
            
            const stats = await response.json();
            
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('pendingOrders').textContent = stats.pendingOrders;
            document.getElementById('shippingOrders').textContent = stats.shippingOrders;
            document.getElementById('completedOrders').textContent = stats.completedOrders;
            
        } catch (error) {
            console.error('‚ùå L·ªói khi t·∫£i th·ªëng k√™:', error);
        }
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™ ƒë∆°n h√†ng
    function updateOrderStats() {
        const totalOrders = allOrders.length;
        const pendingOrders = allOrders.filter(order => order.Status === 'pending').length;
        const shippingOrders = allOrders.filter(order => order.Status === 'shipping').length;
        const completedOrders = allOrders.filter(order => order.Status === 'completed').length;

        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('pendingOrders').textContent = pendingOrders;
        document.getElementById('shippingOrders').textContent = shippingOrders;
        document.getElementById('completedOrders').textContent = completedOrders;
    }

    // Hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng
    function displayOrders() {
        const tbody = document.getElementById('ordersTableBody');
        const pagination = document.getElementById('pagination');
        
        if (!tbody) {
            console.error('‚ùå Kh√¥ng t√¨m th·∫•y b·∫£ng ƒë∆°n h√†ng');
            return;
        }
        
        // L·ªçc ƒë∆°n h√†ng theo b·ªô l·ªçc hi·ªán t·∫°i
        let filteredOrders = filterOrders(allOrders);
        
        // T√≠nh to√°n ph√¢n trang
        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
        const startIndex = (currentPage - 1) * ordersPerPage;
        const endIndex = startIndex + ordersPerPage;
        const currentOrders = filteredOrders.slice(startIndex, endIndex);
        
        // Hi·ªÉn th·ªã ƒë∆°n h√†ng
        tbody.innerHTML = '';
        
        if (currentOrders.length === 0) {
            tbody.innerHTML = `
                <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                    <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                    <p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</p>
                </td>
                </tr>
            `;
        } else {
            currentOrders.forEach(order => {
                const row = document.createElement('tr');
                
                // T·∫°o action buttons d·ª±a tr√™n tr·∫°ng th√°i hi·ªán t·∫°i
                let statusButtonsHTML = '';

                switch(order.Status) {
                    case 'pending':
                        statusButtonsHTML = `
                        <button class="btn btn-success btn-sm" onclick="updateOrderStatus(${order.OrderID}, 'shipping')" title="X√°c nh·∫≠n ƒë∆°n h√†ng">
                            <i class="fas fa-check"></i> X√°c nh·∫≠n
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="updateOrderStatus(${order.OrderID}, 'cancelled')" title="H·ªßy ƒë∆°n h√†ng">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                        `;
                        break;
                    case 'shipping':
                        statusButtonsHTML = `
                        <button class="btn btn-primary btn-sm" onclick="updateOrderStatus(${order.OrderID}, 'completed')" title="ƒê√°nh d·∫•u ƒë√£ giao">
                            <i class="fas fa-check-circle"></i> ƒê√£ giao
                        </button>
                        `;
                        break;
                    case 'completed':
                    case 'cancelled':
                        statusButtonsHTML = '';
                        break;

                        // ƒê∆°n h√†ng ƒë√£ ho√†n th√†nh ho·∫∑c h·ªßy - ch·ªâ hi·ªÉn th·ªã n√∫t xem chi ti·∫øt
                        statusButtonsHTML = '';
                        break;
                    default:
                        statusButtonsHTML = '';
                }
                
                // T·∫§T C·∫¢ c√°c ƒë∆°n h√†ng ƒë·ªÅu c√≥ n√∫t xem chi ti·∫øt, nh∆∞ng CH·ªà TH√äM 1 L·∫¶N
                const actionButtonsHTML = `
                    <button class="btn btn-outline btn-sm" onclick="viewOrderDetail(${order.OrderID})" title="Xem chi ti·∫øt">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${statusButtonsHTML}
                `;
                
                row.innerHTML = `
                    <td><strong>#ORD-${order.OrderID}</strong></td>
                    <td>${order.FullName || 'Kh√°ch h√†ng'}</td>
                    <td>${formatDate(order.OrderDate)}</td>
                    <td>${formatCurrency(order.TotalPrice)}</td>
                    <td><span class="status ${getStatusClass(order.Status)}">${getStatusText(order.Status)}</span></td>
                    <td>${getPaymentMethodText(order.PaymentMethod)}</td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtonsHTML}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Hi·ªÉn th·ªã ph√¢n trang
        renderPagination(totalPages);
    }

    // L·ªçc ƒë∆°n h√†ng
    function filterOrders(orders) {
        let filtered = [...orders];
        
        // L·ªçc theo tr·∫°ng th√°i
        if (currentFilters.status) {
            filtered = filtered.filter(order => order.Status === currentFilters.status);
        }
        
        // L·ªçc theo ng√†y
        if (currentFilters.dateFrom) {
            filtered = filtered.filter(order => new Date(order.OrderDate) >= new Date(currentFilters.dateFrom));
        }
        
        if (currentFilters.dateTo) {
            filtered = filtered.filter(order => new Date(order.OrderDate) <= new Date(currentFilters.dateTo));
        }
        
        // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
        if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            filtered = filtered.filter(order => 
                order.OrderID.toString().includes(searchTerm) ||
                (order.FullName && order.FullName.toLowerCase().includes(searchTerm)) ||
                (order.Email && order.Email.toLowerCase().includes(searchTerm))
            );
        }
        
        return filtered;
    }

    // √Åp d·ª•ng b·ªô l·ªçc
    function applyFilters() {
        currentFilters = {
            status: document.getElementById('statusFilter').value,
            dateFrom: document.getElementById('dateFrom').value,
            dateTo: document.getElementById('dateTo').value,
            search: document.getElementById('searchOrder').value
        };
        
        currentPage = 1;
        displayOrders();
    }

    // ƒê·∫∑t l·∫°i b·ªô l·ªçc
    function resetFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('searchOrder').value = '';
        
        currentFilters = {};
        currentPage = 1;
        displayOrders();
    }

    // Hi·ªÉn th·ªã ph√¢n trang
    function renderPagination(totalPages) {
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // N√∫t Previous
        if (currentPage > 1) {
            paginationHTML += `<button onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
        }
        
        // C√°c n√∫t trang
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="active">${i}</button>`;
            } else {
                paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
            }
        }
        
        // N√∫t Next
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
        }
        
        pagination.innerHTML = paginationHTML;
    }

    // Thay ƒë·ªïi trang
    function changePage(page) {
        currentPage = page;
        displayOrders();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
    async function updateOrderStatus(orderId, newStatus) {
        // Ki·ªÉm tra status c√≥ h·ª£p l·ªá kh√¥ng
        if (!validStatuses[newStatus]) {
            alert(`Tr·∫°ng th√°i "${newStatus}" kh√¥ng h·ª£p l·ªá!`);
            return;
        }
        
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng #${orderId} th√†nh "${getStatusText(newStatus)}"?`)) {
            return;
        }
        
        try {
            console.log("üîÑ Client: Updating order status", { orderId, newStatus });

            const response = await fetch(`/order/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    Status: newStatus
                })
            });

            const result = await response.json();
            
            if (response.ok) {
                alert(result.message || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                loadOrders(); // T·∫£i l·∫°i danh s√°ch
                loadOrderStats(); // T·∫£i l·∫°i th·ªëng k√™
            } else {
                throw new Error(result.message || `L·ªói ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message);
        }
    }

    // Xem chi ti·∫øt ƒë∆°n h√†ng - MODAL
    async function viewOrderDetail(orderId) {
        try {
            console.log("üîç Loading order details for:", orderId);
            
            const response = await fetch(`/order/${orderId}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const orderData = await response.json();
            console.log("üìã Order details:", orderData);
            
            showOrderDetailModal(orderData);
            
        } catch (error) {
            console.error('‚ùå L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng:', error);
            alert('L·ªói khi t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ' + error.message);
        }
    }

    function fixImageUrl(imageUrl) {
        if (!imageUrl) return '/image/default-product.jpg';
        
        // N·∫øu ƒë√£ l√† full URL th√¨ gi·ªØ nguy√™n
        if (imageUrl.startsWith('http')) return imageUrl;
        
        // N·∫øu b·∫Øt ƒë·∫ßu b·∫±ng /html/ th√¨ b·ªè
        if (imageUrl.startsWith('/html/')) {
            imageUrl = imageUrl.replace('/html/', '/');
        }
        
        // N·∫øu kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng /image/ th√¨ th√™m
        if (!imageUrl.startsWith('/image/') && !imageUrl.startsWith('/')) {
            imageUrl = '/image/' + imageUrl;
        } else if (imageUrl.startsWith('/') && !imageUrl.startsWith('/image/')) {
            // ƒê·∫£m b·∫£o b·∫Øt ƒë·∫ßu b·∫±ng /image/
            imageUrl = '/image' + imageUrl;
        }
        
        return imageUrl;
    }

    // Hi·ªÉn th·ªã Modal chi ti·∫øt ƒë∆°n h√†ng
    function showOrderDetailModal(orderData) {
        const order = orderData.order;
        const orderDetails = orderData.orderDetails || [];
        
        // T√≠nh t·ªïng ti·ªÅn t·ª´ c√°c s·∫£n ph·∫©m
        const totalAmount = orderDetails.reduce((sum, item) => {
            return sum + (item.Quantity * item.Price);
        }, 0);
        
        const modalHTML = `
            <div class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Chi ti·∫øt ƒë∆°n h√†ng #ORD-${order.OrderID}</h2>
                        <button class="close-modal" onclick="closeModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="order-sections">
                        <div class="order-info">
                            <h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
                            <div class="info-row">
                                <span class="info-label">M√£ ƒë∆°n h√†ng:</span>
                                <span class="info-value">#ORD-${order.OrderID}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ng√†y ƒë·∫∑t:</span>
                                <span class="info-value">${formatDate(order.OrderDate)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tr·∫°ng th√°i:</span>
                                <span class="info-value status ${getStatusClass(order.Status)}">${getStatusText(order.Status)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ph∆∞∆°ng th·ª©c TT:</span>
                                <span class="info-value">${getPaymentMethodText(order.PaymentMethod)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">T·ªïng ti·ªÅn:</span>
                                <span class="info-value" style="font-weight: 600; color: var(--primary);">${formatCurrency(order.TotalPrice || totalAmount)}</span>
                            </div>
                        </div>
                        
                        <div class="customer-info">
                            <h3>Th√¥ng tin kh√°ch h√†ng</h3>
                            <div class="info-row">
                                <span class="info-label">H·ªç t√™n:</span>
                                <span class="info-value">${order.FullName || 'Ch∆∞a c√≥ th√¥ng tin'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${order.Email || 'Ch∆∞a c√≥ th√¥ng tin'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">SƒêT:</span>
                                <span class="info-value">${order.Phone || 'Ch∆∞a c√≥ th√¥ng tin'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                                <span class="info-value">${order.Address || 'Ch∆∞a c√≥ th√¥ng tin'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-items">
                        <h3>Danh s√°ch s·∫£n ph·∫©m</h3>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orderDetails.length > 0 ? orderDetails.map(item => `
                                    <tr>
                                        <td>
                                            <div class="product-info">
                                                ${item.ImageURL ? 
                                                    `<img src="${fixImageUrl(item.ImageURL)}" alt="${item.ProductName}" class="product-image" 
                                                        onerror="this.src='/image/default-product.jpg'">` : 
                                                    `<div class="product-image" style="background: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                                        <i class="fas fa-box" style="color: #6c757d;"></i>
                                                    </div>`
                                                }
                                                <span>${item.ProductName || 'S·∫£n ph·∫©m'}</span>
                                                ${item.SizeName ? `<span class="product-size">Size: ${item.SizeName}</span>` : ''}
                                            </div>
                                        </td>
                                        <td>${formatCurrency(item.UnitPrice || item.Price)}</td>
                                        <td>${item.Quantity}</td>
                                        <td>${formatCurrency((item.UnitPrice || item.Price) * item.Quantity)}</td>
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 20px; color: #6c757d;">
                                            <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ th√¥ng tin s·∫£n ph·∫©m
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3" style="text-align: right;">T·ªïng c·ªông:</td>
                                    <td>${formatCurrency(order.TotalPrice || totalAmount)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        // X√≥a modal c≈© n·∫øu c√≥
        const existingModal = document.querySelector('.modal-overlay');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Th√™m modal m·ªõi
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // NgƒÉn scroll body khi modal m·ªü
        document.body.style.overflow = 'hidden';
    }

    // ƒê√≥ng Modal
    function closeModal() {
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
            modal.remove();
            // Kh√¥i ph·ª•c scroll body
            document.body.style.overflow = '';
        }
    }

    // ƒê√≥ng modal khi click outside
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal-overlay')) {
            closeModal();
        }
    });

    // ƒê√≥ng modal b·∫±ng ph√≠m ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u khi API l·ªói
    function showFallbackData() {
        const fallbackData = [
            {
                OrderID: 7842,
                FullName: 'Nguy·ªÖn VƒÉn A',
                OrderDate: '2023-10-15',
                TotalPrice: 1250000,
                Status: 'completed',
                PaymentMethod: 'cod'
            },
            {
                OrderID: 7841,
                FullName: 'Tr·∫ßn Th·ªã B',
                OrderDate: '2023-10-14',
                TotalPrice: 2450000,
                Status: 'processing',
                PaymentMethod: 'banking'
            }
        ];
        
        allOrders = fallbackData;
        updateOrderStats();
        displayOrders();
    }

    // C√°c h√†m ph·ª• tr·ª£
    function formatDate(dateString) {
        if (!dateString) return 'Ch∆∞a c√≥ ng√†y';
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    }

    function formatCurrency(amount) {
        if (!amount) return '0 VNƒê';
        return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
    }

    // C√°c status h·ª£p l·ªá theo database
    const validStatuses = {
        'pending': 'ƒêang ch·ªù x√°c nh·∫≠n',
        'shipping': 'ƒêang giao h√†ng',
        'completed': 'ƒê√£ giao h√†ng',
        'cancelled': 'ƒê√£ h·ªßy'
    };

    function getStatusText(status) {
        const statusMap = {
            'pending': 'ƒêang ch·ªù x√°c nh·∫≠n',
            'shipping': 'ƒêang giao h√†ng',
            'completed': 'ƒê√£ giao h√†ng',
            'cancelled': 'ƒê√£ h·ªßy'
        };
        return statusMap[status] || 'ƒêang ch·ªù x√°c nh·∫≠n';
    }

    function getStatusClass(status) {
        const statusMap = {
            'pending': 'pending',
            'shipping': 'shipping',
            'completed': 'completed',
            'cancelled': 'cancelled'
        };
        return statusMap[status] || 'pending';
    }
    
    function getPaymentMethodText(method) {
        const methodMap = {
            'cod': 'Thanh to√°n khi nh·∫≠n h√†ng',
            'banking': 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng',
            'momo': 'V√≠ MoMo',
            'card': 'Th·∫ª thanh to√°n'
        };
        return methodMap[method] || 'Thanh to√°n khi nh·∫≠n h√†ng';
    }

    // X·ª≠ l√Ω menu active
    const menuItems = document.querySelectorAll('.sidebar-menu li');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            menuItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
</script>
</body>
</html>