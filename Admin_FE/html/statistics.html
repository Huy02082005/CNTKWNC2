<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªëng k√™ - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/statistics.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
      <p>Qu·∫£n tr·ªã h·ªá th·ªëng</p>
    </div>
    
    <div class="sidebar-menu">
      <ul>
        <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li><a href="user.html"><i class="fas fa-users"></i> <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span></a></li>
        <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> <span>ƒê∆°n h√†ng</span></a></li>
        <li><a href="products.html"><i class="fas fa-box"></i> <span>S·∫£n ph·∫©m</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-chart-bar"></i> <span>Th·ªëng k√™</span></a></li>
        <li><a href="settings.html"><i class="fas fa-cog"></i> <span>C√†i ƒë·∫∑t</span></a></li>
        <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>ƒêƒÉng xu·∫•t</span></a></li>
      </ul>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Th·ªëng k√™ & B√°o c√°o</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/150?img=12" alt="Admin Avatar">
        <div>
          <h3>Nguy·ªÖn ƒê·ª©c Huy</h3>
          <p>Qu·∫£n tr·ªã vi√™n</p>
        </div>
      </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-group">
        <label>Kho·∫£ng th·ªùi gian</label>
        <select id="timeRange">
          <option value="7">7 ng√†y qua</option>
          <option value="30" selected>30 ng√†y qua</option>
          <option value="90">3 th√°ng qua</option>
          <option value="365">1 nƒÉm qua</option>
          <option value="custom">T√πy ch·ªçn</option>
        </select>
      </div>
      
      <div class="filter-group" id="customDateRange" style="display: none;">
        <label>T·ª´ ng√†y</label>
        <input type="date" id="startDate">
      </div>
      
      <div class="filter-group" id="customDateRangeEnd" style="display: none;">
        <label>ƒê·∫øn ng√†y</label>
        <input type="date" id="endDate">
      </div>
      
      <div class="filter-group">
        <label>Lo·∫°i th·ªëng k√™</label>
        <select id="statType">
          <option value="revenue">Doanh thu</option>
          <option value="orders">ƒê∆°n h√†ng</option>
          <option value="customers">Kh√°ch h√†ng</option>
          <option value="products">S·∫£n ph·∫©m</option>
        </select>
      </div>
      
      <button class="btn btn-primary" onclick="loadStatistics()">
        <i class="fas fa-sync-alt"></i> √Åp d·ª•ng
      </button>
      
      <button class="btn btn-outline" onclick="exportReport()">
        <i class="fas fa-download"></i> Xu·∫•t b√°o c√°o
      </button>
    </div>
    
    <!-- Summary Stats -->
    <div class="stats-grid">
      <div class="stat-item">
        <div class="label">T·ªïng doanh thu</div>
        <div class="value" id="totalRevenue">245M VNƒê</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> 15% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
      </div>
      
      <div class="stat-item">
        <div class="label">T·ªïng ƒë∆°n h√†ng</div>
        <div class="value" id="totalOrders">1,248</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> 8% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
      </div>
      
      <div class="stat-item">
        <div class="label">Kh√°ch h√†ng m·ªõi</div>
        <div class="value" id="newCustomers">156</div>
        <div class="trend up"><i class="fas fa-arrow-up"></i> 12% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
      </div>
      
      <div class="stat-item">
        <div class="label">T·ª∑ l·ªá chuy·ªÉn ƒë·ªïi</div>
        <div class="value" id="conversionRate">3.2%</div>
        <div class="trend down"><i class="fas fa-arrow-down"></i> 0.5% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <h3>Doanh thu theo th·ªùi gian</h3>
          <select id="chartType">
            <option value="line">ƒê∆∞·ªùng</option>
            <option value="bar">C·ªôt</option>
          </select>
        </div>
        <div class="chart-placeholder" id="revenueChart">
          Bi·ªÉu ƒë·ªì doanh thu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <h3>Ph√¢n lo·∫°i ƒë∆°n h√†ng</h3>
        </div>
        <div class="chart-placeholder" id="ordersChart">
          Bi·ªÉu ƒë·ªì ph√¢n lo·∫°i ƒë∆°n h√†ng
        </div>
      </div>
    </div>
    
    <!-- Bottom Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <h3>S·∫£n ph·∫©m b√°n ch·∫°y</h3>
        </div>
        <div class="top-products" id="topProducts">
          <div class="product-item">
            <div class="product-rank">1</div>
            <div class="product-info">
              <div class="product-name">√Åo ƒë·∫•u s√¢n nh√† Manchester United 2023/24</div>
              <div class="product-sales">ƒê√£ b√°n: 245 s·∫£n ph·∫©m</div>
            </div>
            <div class="product-revenue">45.2M VNƒê</div>
          </div>
          <div class="product-item">
            <div class="product-rank">2</div>
            <div class="product-info">
              <div class="product-name">√Åo ƒë·∫•u s√¢n kh√°ch Barcelona 2023/24</div>
              <div class="product-sales">ƒê√£ b√°n: 189 s·∫£n ph·∫©m</div>
            </div>
            <div class="product-revenue">38.7M VNƒê</div>
          </div>
          <div class="product-item">
            <div class="product-rank">3</div>
            <div class="product-info">
              <div class="product-name">Gi√†y b√≥ng ƒë√° Adidas Predator</div>
              <div class="product-sales">ƒê√£ b√°n: 156 s·∫£n ph·∫©m</div>
            </div>
            <div class="product-revenue">32.1M VNƒê</div>
          </div>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <h3>Th·ªëng k√™ theo k√™nh</h3>
        </div>
        <div class="chart-placeholder" id="channelChart">
          Bi·ªÉu ƒë·ªì k√™nh b√°n h√†ng
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    document.addEventListener('DOMContentLoaded', function() {
      const logged = localStorage.getItem("logged");
      const role = localStorage.getItem("role");
      
      if (logged !== "true" || role !== "admin") {
        alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin!");
        window.location.href = "/login.html";
        return;
      }
      
      // C·∫≠p nh·∫≠t t√™n admin n·∫øu c√≥
      const username = localStorage.getItem("username");
      if (username) {
        document.querySelector('.user-info h3').textContent = username;
      }
      
      // Load d·ªØ li·ªáu th·ªëng k√™ khi trang load
      loadStatistics();
      
      // X·ª≠ l√Ω custom date range
      setupEventListeners();
    });

    function setupEventListeners() {
      // X·ª≠ l√Ω hi·ªÉn th·ªã custom date range
      document.getElementById('timeRange').addEventListener('change', function() {
        const customDateRange = document.getElementById('customDateRange');
        const customDateRangeEnd = document.getElementById('customDateRangeEnd');
        
        if (this.value === 'custom') {
          customDateRange.style.display = 'flex';
          customDateRangeEnd.style.display = 'flex';
          
          // Set default dates for custom range
          const today = new Date();
          const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          
          document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
          document.getElementById('endDate').value = today.toISOString().split('T')[0];
        } else {
          customDateRange.style.display = 'none';
          customDateRangeEnd.style.display = 'none';
        }
      });
    }

    // H√†m t·∫£i d·ªØ li·ªáu th·ªëng k√™
    async function loadStatistics() {
      try {
        console.log("üîÑ ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...");
        showLoading(true);
        clearError();
        
        const timeRange = document.getElementById('timeRange').value;
        const statType = document.getElementById('statType').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        const url = `/stats/statistics?range=${timeRange}&type=${statType}&start=${startDate}&end=${endDate}`;
        console.log('üì° Calling URL:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("üìä D·ªØ li·ªáu th·ªëng k√™ nh·∫≠n ƒë∆∞·ª£c:", data);
        
        if (data.success) {
          updateStatisticsUI(data);
        } else {
          throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server');
        }
        
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i th·ªëng k√™:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™: ' + error.message);
        showFallbackStatistics();
      } finally {
        showLoading(false);
      }
    }

    // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu th·ªëng k√™
    function updateStatisticsUI(data) {
      console.log("üîÑ Updating UI with data:", data);
      
      // 1. C·∫≠p nh·∫≠t c√°c s·ªë li·ªáu t·ªïng quan
      updateSummaryStats(data.summary);
      
      // 2. C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
      updateCharts(data.charts);
      
      // 3. C·∫≠p nh·∫≠t top s·∫£n ph·∫©m
      updateTopProducts(data.topProducts);
      
      // 4. C·∫≠p nh·∫≠t th·ªëng k√™ k√™nh
      updateChannelStats(data.channels);
    }

    function updateSummaryStats(summary) {
      if (!summary) {
        console.warn('No summary data');
        return;
      }
      
      // S·ª≠ d·ª•ng to√°n t·ª≠ ?? ƒë·ªÉ tr√°nh l·ªói undefined
      document.getElementById('totalRevenue').textContent = 
          formatCurrency(summary.TotalRevenue ?? 0);
      document.getElementById('totalOrders').textContent = 
          (summary.TotalOrders ?? 0).toLocaleString();
      document.getElementById('newCustomers').textContent = 
          (summary.NewCustomers ?? 0).toLocaleString();
      document.getElementById('conversionRate').textContent = 
          (summary.ConversionRate ?? 0).toFixed(1) + '%';
    }

    function updateCharts(charts) {
      if (!charts) {
        console.warn('No charts data');
        return;
      }
      
      // Bi·ªÉu ƒë·ªì doanh thu
      const revenueChart = document.getElementById('revenueChart');
      if (charts.revenue && charts.revenue.length > 0) {
        const total = charts.revenue.reduce((sum, item) => sum + (item.DailyRevenue || 0), 0);
        revenueChart.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <i class="fas fa-chart-line" style="font-size: 3rem; color: #4361ee; margin-bottom: 15px;"></i>
            <p><strong>Doanh thu theo th·ªùi gian</strong></p>
            <p style="font-size: 0.9rem; color: #6c757d;">
              T·ªïng: ${formatCurrency(total)}<br>
              ${charts.revenue.length} ng√†y c√≥ d·ªØ li·ªáu
            </p>
            <div style="margin-top: 15px; font-size: 0.8rem;">
              <div>üí∞ Cao nh·∫•t: ${formatCurrency(Math.max(...charts.revenue.map(r => r.DailyRevenue || 0)))}</div>
              <div>üìä Trung b√¨nh: ${formatCurrency(total / charts.revenue.length)}</div>
            </div>
          </div>
        `;
      } else {
        revenueChart.innerHTML = `
          <div class="no-data">
            <i class="fas fa-chart-line"></i>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu</p>
          </div>
        `;
      }
      
      // Bi·ªÉu ƒë·ªì ƒë∆°n h√†ng
      const ordersChart = document.getElementById('ordersChart');
      if (charts.orders && charts.orders.length > 0) {
        const total = charts.orders.reduce((sum, item) => sum + (item.OrderCount || 0), 0);
        ordersChart.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <i class="fas fa-chart-pie" style="font-size: 3rem; color: #f72585; margin-bottom: 15px;"></i>
            <p><strong>Ph√¢n b·ªë tr·∫°ng th√°i ƒë∆°n h√†ng</strong></p>
            <div style="margin-top: 15px; text-align: left;">
              ${charts.orders.map(order => `
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>${getStatusText(order.Status)}:</span>
                  <strong>${order.OrderCount}</strong>
                </div>
              `).join('')}
            </div>
            <p style="font-size: 0.9rem; color: #6c757d; margin-top: 10px;">
              T·ªïng: ${total} ƒë∆°n h√†ng
            </p>
          </div>
        `;
      } else {
        ordersChart.innerHTML = `
          <div class="no-data">
            <i class="fas fa-chart-pie"></i>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu ƒë∆°n h√†ng</p>
          </div>
        `;
      }
    }

    function updateTopProducts(products) {
      const container = document.getElementById('topProducts');
      if (!container) return;
      
      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <i class="fas fa-box-open"></i>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m b√°n ch·∫°y</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = products.map((product, index) => `
        <div class="product-item">
          <div class="product-rank">${index + 1}</div>
          <div class="product-info">
            <div class="product-name">${product.ProductName || 'S·∫£n ph·∫©m kh√¥ng t√™n'}</div>
            <div class="product-sales">ƒê√£ b√°n: ${(product.TotalSold || 0).toLocaleString()} s·∫£n ph·∫©m</div>
          </div>
          <div class="product-revenue">${formatCurrency(product.TotalRevenue || 0)}</div>
        </div>
      `).join('');
    }

    function updateChannelStats(channels) {
      const container = document.getElementById('channelChart');
      if (!container) return;
      
      if (!channels || channels.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <i class="fas fa-tags"></i>
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n lo·∫°i</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <i class="fas fa-tags" style="font-size: 3rem; color: #4cc9f0; margin-bottom: 15px;"></i>
          <p><strong>Th·ªëng k√™ theo danh m·ª•c</strong></p>
          <div style="margin-top: 15px; text-align: left;">
            ${channels.map(channel => `
              <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                <span>${channel.CategoryName}:</span>
                <strong>${formatCurrency(channel.TotalRevenue || 0)}</strong>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u
    function showFallbackStatistics() {
      console.log("‚ö†Ô∏è Hi·ªÉn th·ªã d·ªØ li·ªáu th·ªëng k√™ m·∫´u");
      
      const sampleData = {
        summary: {
          TotalRevenue: 245000000,
          TotalOrders: 1248,
          NewCustomers: 156,
          ConversionRate: 78.5
        },
        charts: {
          revenue: [
            { Date: '2024-01-01', DailyRevenue: 12000000, DailyOrders: 45 },
            { Date: '2024-01-02', DailyRevenue: 15000000, DailyOrders: 52 }
          ],
          orders: [
            { Status: 'completed', OrderCount: 980 },
            { Status: 'pending', OrderCount: 156 }
          ]
        },
        topProducts: [
          { ProductName: "√Åo ƒë·∫•u Manchester United 2023/24", TotalSold: 245, TotalRevenue: 45200000 },
          { ProductName: "√Åo ƒë·∫•u Barcelona 2023/24", TotalSold: 189, TotalRevenue: 38700000 }
        ],
        channels: [
          { CategoryName: "√Åo ƒë·∫•u", TotalRevenue: 120000000 },
          { CategoryName: "Gi√†y b√≥ng ƒë√°", TotalRevenue: 80000000 }
        ]
      };
      
      updateStatisticsUI(sampleData);
    }

    // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
    function formatCurrency(amount) {
      if (amount === undefined || amount === null) return '0 VNƒê';
      return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
    }

    // H√†m xu·∫•t b√°o c√°o
    async function exportReport() {
      try {
        const timeRange = document.getElementById('timeRange').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        const response = await fetch('/stats/export-report', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: 'excel',
            range: timeRange,
            start: startDate,
            end: endDate
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ B√°o c√°o ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng!');
        } else {
          throw new Error(result.message);
        }
        
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t b√°o c√°o:', error);
        alert('‚ùå L·ªói khi xu·∫•t b√°o c√°o: ' + error.message);
      }
    }

    // H√†m ph·ª• tr·ª£
    function getStatusText(status) {
      const statusMap = {
        'pending': 'ƒêang ch·ªù',
        'completed': 'Ho√†n th√†nh', 
        'shipping': 'ƒêang giao',
        'cancelled': 'ƒê√£ h·ªßy'
      };
      return statusMap[status] || status;
    }

    // Loading functions
    function showLoading(show) {
      let loader = document.getElementById('loadingIndicator');
      if (!loader) {
        loader = document.createElement('div');
        loader.id = 'loadingIndicator';
        loader.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          z-index: 1000;
          text-align: center;
        `;
        loader.innerHTML = `
          <div class="loading" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
          <p>ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
        `;
        document.body.appendChild(loader);
      }
      loader.style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      clearError();
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        max-width: 400px;
      `;
      errorDiv.innerHTML = `
        <strong>‚ùå L·ªói:</strong> ${message}
        <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: none; border: none; color: #721c24; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      `;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        if (errorDiv.parentElement) {
          errorDiv.remove();
        }
      }, 5000);
    }

    function clearError() {
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }
    }

    // H√†m ƒëƒÉng xu·∫•t
    function logout() {
      localStorage.removeItem("logged");
      localStorage.removeItem("role");
      localStorage.removeItem("username");
      window.location.href = "login.html";
    }

    // X·ª≠ l√Ω menu active
    const menuItems = document.querySelectorAll('.sidebar-menu li');
    menuItems.forEach(item => {
      item.addEventListener('click', function() {
        menuItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');
      });
    });
  </script>
</body>
</html>