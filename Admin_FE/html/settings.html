<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cài đặt Hệ thống - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/settings.css">
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
      <p>Quản trị hệ thống</p>
    </div>
    
    <div class="sidebar-menu">
      <ul>
        <li><a href="dashboard.html"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
        <li><a href="user.html"><i class="fas fa-users"></i> <span>Quản lý người dùng</span></a></li>
        <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> <span>Đơn hàng</span></a></li>
        <li><a href="products.html"><i class="fas fa-box"></i> <span>Sản phẩm</span></a></li>
        <li><a href="admin.html"><i class="fas fa-user-shield"></i> <span>Quản lý admin</span></a></li>
        <li class="active"><a href="#"><i class="fas fa-cog"></i> <span>Cài đặt</span></a></li>
        <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span>Đăng xuất</span></a></li>
      </ul>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>Cài đặt Hệ thống</h1>
      <div class="user-info">
        <img src="https://i.pravatar.cc/150?img=12" alt="Admin Avatar">
        <div>
          <h3>Nguyễn Đức Huy</h3>
          <p>Quản trị viên</p>
        </div>
      </div>
    </div>
    
    <!-- Settings Container -->
    <div class="settings-container">
      <!-- System Configuration -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-sliders-h"></i> Cấu hình Hệ thống</h2>
        </div>
        <form id="systemConfigForm">
          <div class="form-group">
            <label for="storeName">Tên cửa hàng</label>
            <input type="text" id="storeName" class="form-control" value="FootballStore">
          </div>
          
          <div class="form-group">
            <label for="storeEmail">Email cửa hàng</label>
            <input type="email" id="storeEmail" class="form-control" value="contact@footballstore.com">
          </div>
          
          <div class="form-group">
            <label for="storePhone">Số điện thoại</label>
            <input type="tel" id="storePhone" class="form-control" value="+84 123 456 789">
          </div>
          
          <div class="form-group">
            <label for="storeAddress">Địa chỉ cửa hàng</label>
            <textarea id="storeAddress" class="form-control" rows="3">123 Đường ABC, Quận 1, TP.HCM</textarea>
          </div>
          
          <div class="form-group">
            <label for="currency">Đơn vị tiền tệ</label>
            <select id="currency" class="form-control">
              <option value="VND" selected>VNĐ (Việt Nam Đồng)</option>
              <option value="USD">USD (Đô la Mỹ)</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary">Lưu cấu hình</button>
        </form>
      </div>
      
      <!-- Notification Settings -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-bell"></i> Cài đặt Thông báo</h2>
        </div>
        <div class="form-group">
          <div class="toggle-label">
            <span>Thông báo đơn hàng mới</span>
            <label class="toggle-switch">
              <input type="checkbox" id="newOrderNotify" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Thông báo khách hàng mới</span>
            <label class="toggle-switch">
              <input type="checkbox" id="newCustomerNotify" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Thông báo sản phẩm sắp hết hàng</span>
            <label class="toggle-switch">
              <input type="checkbox" id="lowStockNotify" checked>
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="toggle-label">
            <span>Thông báo đánh giá mới</span>
            <label class="toggle-switch">
              <input type="checkbox" id="newReviewNotify">
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="notificationEmail">Email nhận thông báo</label>
          <input type="email" id="notificationEmail" class="form-control" value="admin@footballstore.com">
        </div>
        
        <button type="button" class="btn btn-primary" id="saveNotificationSettings">Lưu cài đặt</button>
      </div>
      
      <!-- Security Settings -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-shield-alt"></i> Bảo mật</h2>
        </div>
        <form id="securityForm">
          <div class="form-group">
            <label for="sessionTimeout">Thời gian hết phiên (phút)</label>
            <input type="number" id="sessionTimeout" class="form-control" value="30" min="5" max="120">
          </div>
          
          <div class="form-group">
            <label for="maxLoginAttempts">Số lần đăng nhập tối đa</label>
            <input type="number" id="maxLoginAttempts" class="form-control" value="5" min="3" max="10">
          </div>
          
          <div class="form-group">
            <div class="toggle-label">
              <span>Yêu cầu mật khẩu mạnh</span>
              <label class="toggle-switch">
                <input type="checkbox" id="strongPassword" checked>
                <span class="slider"></span>
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <div class="toggle-label">
              <span>Bật xác thực 2 bước</span>
              <label class="toggle-switch">
                <input type="checkbox" id="twoFactorAuth">
                <span class="slider"></span>
              </label>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary">Cập nhật bảo mật</button>
        </form>
      </div>
      
      <!-- System Maintenance -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-tools"></i> Bảo trì Hệ thống</h2>
        </div>
        <div class="form-group">
          <div class="toggle-label">
            <span>Chế độ bảo trì</span>
            <label class="toggle-switch">
              <input type="checkbox" id="maintenanceMode">
              <span class="slider"></span>
            </label>
          </div>
          <p class="help-text">Khi bật, website sẽ hiển thị thông báo bảo trì cho khách hàng</p>
        </div>
        
        <div class="form-group">
          <label for="maintenanceMessage">Thông báo bảo trì</label>
          <textarea id="maintenanceMessage" class="form-control" rows="3">Hệ thống đang được bảo trì. Vui lòng quay lại sau.</textarea>
        </div>
        
        <div class="form-group">
          <label>Trạng thái hệ thống</label>
          <div>
            <span class="status-indicator status-active">Đang hoạt động</span>
          </div>
        </div>
        
        <div class="form-group">
          <label>Phiên bản hệ thống</label>
          <div>
            <span>v1.0.0</span>
          </div>
        </div>
        
        <button type="button" class="btn btn-outline" id="clearCache">Xóa cache</button>
        <button type="button" class="btn btn-outline" id="backupSystem">Sao lưu dữ liệu</button>
      </div>
      
      <!-- Payment & Shipping -->
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-credit-card"></i> Thanh toán & Vận chuyển</h2>
        </div>
        <div class="form-group">
          <div class="toggle-label">
            <span>Thanh toán khi nhận hàng (COD)</span>
            <label class="toggle-switch">
              <input type="checkbox" id="codPayment" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <div class="toggle-label">
            <span>Chuyển khoản ngân hàng</span>
            <label class="toggle-switch">
              <input type="checkbox" id="bankTransfer" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="shippingFee">Phí vận chuyển cơ bản (VNĐ)</label>
          <input type="number" id="shippingFee" class="form-control" value="30000" min="0">
        </div>
        
        <div class="form-group">
          <label for="freeShippingThreshold">Ngưỡng miễn phí vận chuyển (VNĐ)</label>
          <input type="number" id="freeShippingThreshold" class="form-control" value="500000" min="0">
        </div>
        
        <button type="button" class="btn btn-primary" id="savePaymentSettings">Lưu cài đặt</button>
      </div>
      
      <!-- Danger Zone -->
      <div class="card danger-zone">
        <div class="card-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Khu vực Nguy hiểm</h2>
        </div>
        <div class="form-group">
          <p>Xóa tất cả dữ liệu hệ thống. Hành động này không thể hoàn tác.</p>
          <button type="button" class="btn btn-danger" id="resetSystem">Đặt lại hệ thống</button>
        </div>
        
        <div class="form-group">
          <p>Xóa tất cả dữ liệu khách hàng và đơn hàng.</p>
          <button type="button" class="btn btn-danger" id="purgeData">Xóa dữ liệu</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Hàm helper để làm việc với cookies
    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) {
          return decodeURIComponent(cookieValue);
        }
      }
      return null;
    }
    
    function setCookie(name, value, days = 7) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = "expires=" + date.toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)};${expires};path=/`;
    }
    
    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
    }
    
    // Kiểm tra trạng thái đăng nhập
    document.addEventListener('DOMContentLoaded', function() {
      const userDataCookie = getCookie("user_data");
      
      if (!userDataCookie) {
        // Nếu chưa đăng nhập thì chuyển về trang login
        window.location.href = "/login.html";
        return;
      }
      
      try {
        const user = JSON.parse(userDataCookie);
        // Hiển thị thông tin admin nếu có
        if (user.username) {
          document.querySelector('.user-info h3').textContent = user.username;
        }
        
        // Kiểm tra nếu không phải super admin thì ẩn menu quản lý admin
        if (!user.isSuperAdmin) {
          const adminMenuItem = document.querySelector('.sidebar-menu a[href="admin.html"]').parentElement;
          adminMenuItem.style.display = 'none';
        }
        
        // Tải cài đặt hiện tại
        loadCurrentSettings();
        loadSettingsFromCookies();
      } catch (error) {
        console.error('Lỗi parse cookie:', error);
        window.location.href = "/login.html";
      }
    });
    
    // Hàm đăng xuất
    async function logout() {
      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          // Xóa cookies client side
          deleteCookie("user_data");
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error('Logout error:', error);
        // Vẫn redirect về login
        deleteCookie("user_data");
        window.location.href = "login.html";
      }
    }
    
    // Xử lý menu active
    const menuItems = document.querySelectorAll('.sidebar-menu li');
    menuItems.forEach(item => {
      item.addEventListener('click', function() {
        menuItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');
      });
    });
    
    // Tải cài đặt hiện tại từ server
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/settings');
        if (!response.ok) throw new Error('Failed to load settings');
        
        const settings = await response.json();
        
        // Điền giá trị vào form
        document.getElementById('storeName').value = settings.StoreName || '';
        document.getElementById('storeEmail').value = settings.StoreEmail || '';
        // ... tiếp tục cho các trường khác
        
      } catch (error) {
        console.error('Error loading settings:', error);
        // Không cần alert
      }
    }
    
    // Tải cài đặt từ cookies
    function loadSettingsFromCookies() {
      try {
        // Notification settings
        const notificationSettings = getCookie("notificationSettings");
        if (notificationSettings) {
          const settings = JSON.parse(notificationSettings);
          document.getElementById('newOrderNotify').checked = settings.newOrderNotify || false;
          document.getElementById('newCustomerNotify').checked = settings.newCustomerNotify || false;
          document.getElementById('lowStockNotify').checked = settings.lowStockNotify || false;
          document.getElementById('newReviewNotify').checked = settings.newReviewNotify || false;
          document.getElementById('notificationEmail').value = settings.notificationEmail || 'admin@footballstore.com';
        }
        
        // Security settings
        const securitySettings = getCookie("securitySettings");
        if (securitySettings) {
          const settings = JSON.parse(securitySettings);
          document.getElementById('sessionTimeout').value = settings.sessionTimeout || 30;
          document.getElementById('maxLoginAttempts').value = settings.maxLoginAttempts || 5;
          document.getElementById('strongPassword').checked = settings.strongPassword || false;
          document.getElementById('twoFactorAuth').checked = settings.twoFactorAuth || false;
        }
        
        // Payment settings
        const paymentSettings = getCookie("paymentSettings");
        if (paymentSettings) {
          const settings = JSON.parse(paymentSettings);
          document.getElementById('codPayment').checked = settings.codPayment || false;
          document.getElementById('bankTransfer').checked = settings.bankTransfer || false;
          document.getElementById('shippingFee').value = settings.shippingFee || 30000;
          document.getElementById('freeShippingThreshold').value = settings.freeShippingThreshold || 500000;
        }
      } catch (error) {
        console.error('Error loading settings from cookies:', error);
      }
    }
    
    // Lưu cấu hình hệ thống
    document.getElementById('systemConfigForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const settings = {
        storeName: document.getElementById('storeName').value,
        storeEmail: document.getElementById('storeEmail').value,
        storePhone: document.getElementById('storePhone').value,
        storeAddress: document.getElementById('storeAddress').value,
        currency: document.getElementById('currency').value
      };
      
      try {
        const response = await fetch('/settings', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });
        
        if (!response.ok) throw new Error('Failed to save settings');
        
        alert('Cấu hình hệ thống đã được lưu!');
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Lỗi khi lưu cấu hình');
      }
    });
    
    // Lưu cài đặt thông báo vào cookies
    document.getElementById('saveNotificationSettings').addEventListener('click', function() {
      const notificationSettings = {
        newOrderNotify: document.getElementById('newOrderNotify').checked,
        newCustomerNotify: document.getElementById('newCustomerNotify').checked,
        lowStockNotify: document.getElementById('lowStockNotify').checked,
        newReviewNotify: document.getElementById('newReviewNotify').checked,
        notificationEmail: document.getElementById('notificationEmail').value
      };
      
      setCookie('notificationSettings', JSON.stringify(notificationSettings));
      alert('Cài đặt thông báo đã được lưu!');
    });
    
    // Cập nhật bảo mật vào cookies
    document.getElementById('securityForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const securitySettings = {
        sessionTimeout: document.getElementById('sessionTimeout').value,
        maxLoginAttempts: document.getElementById('maxLoginAttempts').value,
        strongPassword: document.getElementById('strongPassword').checked,
        twoFactorAuth: document.getElementById('twoFactorAuth').checked
      };
      
      setCookie('securitySettings', JSON.stringify(securitySettings));
      alert('Cài đặt bảo mật đã được cập nhật!');
    });
    
    // Xóa cache
    document.getElementById('clearCache').addEventListener('click', function() {
      if (confirm('Bạn có chắc chắn muốn xóa cache hệ thống?')) {
        alert('Cache đã được xóa!');
      }
    });
    
    // Sao lưu dữ liệu
    document.getElementById('backupSystem').addEventListener('click', function() {
      alert('Đã bắt đầu quá trình sao lưu dữ liệu. Bạn sẽ nhận được thông báo khi hoàn tất.');
    });
    
    // Lưu cài đặt thanh toán vào cookies
    document.getElementById('savePaymentSettings').addEventListener('click', function() {
      const paymentSettings = {
        codPayment: document.getElementById('codPayment').checked,
        bankTransfer: document.getElementById('bankTransfer').checked,
        shippingFee: document.getElementById('shippingFee').value,
        freeShippingThreshold: document.getElementById('freeShippingThreshold').value
      };
      
      setCookie('paymentSettings', JSON.stringify(paymentSettings));
      alert('Cài đặt thanh toán & vận chuyển đã được lưu!');
    });
    
    // Đặt lại hệ thống
    document.getElementById('resetSystem').addEventListener('click', function() {
      const confirmReset = confirm('Bạn có chắc chắn muốn đặt lại toàn bộ hệ thống? Tất cả dữ liệu sẽ bị xóa và không thể khôi phục!');
      
      if (confirmReset) {
        const password = prompt('Vui lòng nhập mật khẩu của bạn để xác nhận:');
        
        if (password) {
          alert('Hệ thống sẽ được đặt lại. Bạn sẽ được đăng xuất ngay bây giờ.');
          logout();
        }
      }
    });
    
    // Xóa dữ liệu
    document.getElementById('purgeData').addEventListener('click', function() {
      const confirmPurge = confirm('Bạn có chắc chắn muốn xóa tất cả dữ liệu khách hàng và đơn hàng? Hành động này không thể hoàn tác!');
      
      if (confirmPurge) {
        const password = prompt('Vui lòng nhập mật khẩu của bạn để xác nhận:');
        
        if (password) {
          alert('Dữ liệu đã được xóa thành công!');
        }
      }
    });
  </script>
</body>
</html>