<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:3000; connect-src 'self' http://localhost:3000 ws://localhost:3000; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com;">
  <title>Qu√™n M·∫≠t Kh·∫©u</title>
  <link rel="stylesheet" href="/css/forgotpassword.css">
</head>

<body>
  <div class="forgot-container">
    <div class="logo-icon">üîí</div>
    
    <h2>Qu√™n M·∫≠t Kh·∫©u</h2>
    <p class="subtitle">Nh·∫≠p email ƒë·ªÉ kh√¥i ph·ª•c m·∫≠t kh·∫©u</p>
    
    <div class="input-group">
      <label class="input-label" for="email">Email c·ªßa b·∫°n</label>
      <input type="email" id="email" class="input-field" placeholder="vidu@email.com" autocomplete="email">
    </div>
    
    <div class="success-message" id="successMessage"></div>
    <div class="error-message" id="errorMessage"></div>
    
    <div class="reset-section" id="resetSection">
      <div class="input-group">
        <label class="input-label" for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
        <input type="password" id="newPassword" class="input-field" placeholder="√çt nh·∫•t 6 k√Ω t·ª±">
      </div>
      
      <div class="input-group">
        <label class="input-label" for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
        <input type="password" id="confirmPassword" class="input-field" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
      </div>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText" style="font-size: 13px;">ƒêang x·ª≠ l√Ω...</p>
    </div>
    
    <div class="button-group">
      <button type="button" class="btn btn-primary" onclick="checkEmail()" id="actionBtn">
        Ti·∫øp Theo
      </button>
      <button type="button" class="btn btn-secondary" onclick="goBack()">
        Quay L·∫°i
      </button>
    </div>
    
    <div class="footer">
      <a href="login.html" class="back-link">
        <span>‚Üê</span> Quay l·∫°i trang ƒëƒÉng nh·∫≠p
      </a>
    </div>
  </div>

  <script>
    let emailVerified = false;
    let userEmail = '';

    document.getElementById('email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') checkEmail();
    });

    document.getElementById('newPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && emailVerified) resetPassword();
    });

    document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && emailVerified) resetPassword();
    });

    function showSuccess(message) {
        const successElement = document.getElementById('successMessage');
        successElement.textContent = message;
        successElement.style.display = 'block';
        hideError();
    }

    function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        hideSuccess();
    }

    function hideSuccess() {
        document.getElementById('successMessage').style.display = 'none';
    }

    function hideError() {
        document.getElementById('errorMessage').style.display = 'none';
    }

    function showLoading(text = 'ƒêang x·ª≠ l√Ω...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function checkEmail() {
        const email = document.getElementById("email").value.trim();

        if (!email) {
            showError("Vui l√≤ng nh·∫≠p email");
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showError("Vui l√≤ng nh·∫≠p email h·ª£p l·ªá");
            return;
        }

        hideError();
        showLoading('ƒêang ki·ªÉm tra email...');

        fetch("http://localhost:3000/auth/check-email", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        })
        .then(response => {
            if (!response.ok) throw new Error('L·ªói k·∫øt n·ªëi server');
            return response.json();
        })
        .then(data => {
            hideLoading();
            
            if (data.exists) {
                emailVerified = true;
                userEmail = email;
                showSuccess("‚úÖ Email t·ªìn t·∫°i! Vui l√≤ng t·∫°o m·∫≠t kh·∫©u m·ªõi.");
                
                // ·∫®n input email
                document.querySelector('.input-group').style.display = 'none';
                document.getElementById('resetSection').style.display = 'block';
                
                document.getElementById('actionBtn').textContent = 'ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u';
                document.getElementById('actionBtn').setAttribute('onclick', 'resetPassword()');
                document.getElementById('newPassword').focus();
            } else {
                showError("‚ùå Email kh√¥ng t·ªìn t·∫°i");
            }
        })
        .catch(error => {
            hideLoading();
            console.error('L·ªói:', error);
            showError("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server");
        });
    }

    function resetPassword() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (!newPassword || !confirmPassword) {
            showError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m·∫≠t kh·∫©u m·ªõi");
            return;
        }

        if (newPassword.length < 6) {
            showError("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±");
            return;
        }

        if (newPassword !== confirmPassword) {
            showError("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp");
            return;
        }

        hideError();
        showLoading('ƒêang ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u...');

        fetch("http://localhost:3000/auth/reset-password", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                email: userEmail, 
                newPassword: newPassword 
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('L·ªói k·∫øt n·ªëi server');
            return response.json();
        })
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showSuccess("üéâ ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...");
                document.getElementById('actionBtn').disabled = true;
                
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 1500);
            } else {
                showError(data.message || "C√≥ l·ªói x·∫£y ra");
            }
        })
        .catch(error => {
            hideLoading();
            console.error('L·ªói:', error);
            showError("‚ö†Ô∏è C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i");
        });
    }

    function goBack() {
        window.location.href = "login.html";
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById("email").focus();
    });
  </script>
</body>
</html>